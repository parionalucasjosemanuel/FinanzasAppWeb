<!doctype html>
<html lang="es">
<head>
   <link rel="icon" type="image/png" href="icon.png">
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Plan de Pagos - MiHogarFinanzas</title>
<link rel="stylesheet" href="assets.css">
<style>
  .content-box {background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:2rem;}
  label {display:block;margin-top:0.8rem;font-size:0.9rem;color:#333;}
  input {width:100%;padding:0.7rem;border:1px solid #ccc;border-radius:8px;margin-top:0.3rem;}
  button {margin-top:1rem;padding:0.8rem 1.5rem;border:none;border-radius:8px;background:#1a73e8;color:white;font-weight:bold;cursor:pointer;transition:0.3s;}
  button:hover {background:#0f5dd1;}
  table {width:100%;border-collapse:collapse;margin-top:1rem;}
  th,td {padding:0.8rem;text-align:center;border-bottom:1px solid #ddd;}
  th {background:#1a73e8;color:white;}
  tr:hover {background:#f1f1f1;}
  .summary {margin-top:1rem;padding:1rem;background:#e8f0fe;border-left:5px solid #1a73e8;border-radius:8px;}
  .success{margin-top:1rem;color:green;font-weight:bold;}
  .error{color:red;margin-top:0.5rem;}

  * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif;}
body {display: flex; height: 100vh; background: #f4f6f9;}

.sidebar {
  width: 250px; background: #1a73e8; color: white;
  display: flex; flex-direction: column; padding: 1rem;
}

.sidebar h3 {text-align: center; margin-bottom: 2rem;}

.sidebar a {
  text-decoration: none; color: white; padding: 0.8rem;
  margin: 0.3rem 0; display: block; border-radius: 8px; transition: 0.3s;
}

.sidebar a:hover {background: #0f5dd1;}

.main {
  flex: 1; padding: 2rem; overflow-y: auto;
}

.logout {margin-top: auto; text-align: center;}

.logout button {
  background: red; border: none; color: white; padding: 0.7rem 1rem;
  border-radius: 8px; cursor: pointer; transition: 0.3s; width: 100%;
}

.logout button:hover {background: darkred;}
.brand {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 2rem;
}

.brand img {
  width: 35px;       /* tama√±o del logo */
  height: 35px;
  border-radius: 50%; /* si quieres redondo, si no: borra esta l√≠nea */
  object-fit: cover;
}

.brand span {
  font-weight: bold;
  font-size: 1.1rem;
}

</style>
</head>
<body>

<div class="sidebar">
  <div class="brand">
  <img src="logo.png" alt="Logo">
  <span>MiHogarFinanzas</span>
</div>
  <a href="/dashboard.html">üè† Dashboard</a>
  <a href="/clientes.html">üë§ Clientes</a>
  <a href="/inmuebles.html">üèòÔ∏è Unidades</a>
  <a href="/configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
  <a href="/planpagos.html">üìä Plan de Pagos</a>
  <a href="/indicadores.html">üìà Indicadores</a>
  <a href="/reportes.html">üóÇ Reportes</a>
  <a href="/ayuda.html">‚ùì Ayuda</a>

  <div class="logout">
    <button id="logout">Cerrar Sesi√≥n</button>
  </div>
</div>

<div class="main">
  <h1>Generaci√≥n del Plan de Pagos</h1>

  <div class="content-box">
    <form id="pagoForm">
      <label>Cliente</label>
      <select id="clientSelect">
        <option value="">Cargando clientes...</option>
      </select>

      <label>Propiedad</label>
      <select id="propertySelect">
        <option value="">Cargando propiedades...</option>
      </select>

      <label>Monto del Pr√©stamo</label>
      <input type="number" id="monto" required>

      <label>Plazo (meses)</label>
      <input type="number" id="plazo" required>

      <label>Tasa de Inter√©s Anual (%)</label>
      <input type="number" id="tasa" step="0.01" required>

      <label>Fecha de Inicio</label>
      <input type="date" id="fecha">

      <button type="submit">Generar Plan y Guardar Cr√©dito</button>
      <p id="msg" class="error"></p>
      <p id="ok" class="success" style="display:none;"></p>
    </form>
  </div>

  <div class="content-box">
    <h2>Cronograma de Pagos</h2>
    <div id="resumen" class="summary" style="display:none;"></div>
    <table id="tablaPagos">
      <thead>
      <tr>
        <th>Cuota</th>
        <th>Amortizaci√≥n</th>
        <th>Inter√©s</th>
        <th>Cuota Total</th>
        <th>Saldo</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const api='/api';
const token = localStorage.getItem('mhf_token');
if(!token){ alert('Inicia sesi√≥n'); location.href='/login.html'; }

document.getElementById('logout').onclick = ()=>{
  localStorage.removeItem('mhf_token');
  localStorage.removeItem('mhf_user');
  window.location.href='/login.html';
};

const pagoForm = document.getElementById("pagoForm");
const tabla = document.querySelector("#tablaPagos tbody");
const resumen = document.getElementById("resumen");
const msg = document.getElementById("msg");
const ok = document.getElementById("ok");

// Cargar clientes y propiedades para los selects
async function loadClientsAndProperties(){
  try{
    const clientsRes = await fetch(api + '/clients', { headers: { Authorization: 'Bearer ' + token } });
    const propsRes = await fetch(api + '/properties', { headers: { Authorization: 'Bearer ' + token } });
    const clients = await clientsRes.json();
    const props = await propsRes.json();

    const clientSel = document.getElementById('clientSelect');
    clientSel.innerHTML = '<option value="">Seleccione un cliente...</option>' + clients.map(c=>`<option value="${c.id}">${c.id} - ${c.full_name} (${c.dni})</option>`).join('');

    const propSel = document.getElementById('propertySelect');
    propSel.innerHTML = '<option value="">Seleccione una propiedad...</option>' + props.map(p=>`<option value="${p.id}">${p.id} - ${p.project_name} - ${p.currency === 'PEN' ? 'S/ ' : '$'}${p.price}</option>`).join('');
  }catch(err){
    console.error('Error cargando clientes/propiedades', err);
    document.getElementById('clientSelect').innerHTML = '<option value="">Error cargando clientes</option>';
    document.getElementById('propertySelect').innerHTML = '<option value="">Error cargando propiedades</option>';
  }
}

loadClientsAndProperties();

pagoForm.onsubmit = async function(e){
  e.preventDefault();
  const clientId = parseInt(document.getElementById('clientSelect').value);
  const propertyId = parseInt(document.getElementById('propertySelect').value);
  if(!clientId || !propertyId){
    msg.innerText = "Debes seleccionar un cliente y una propiedad.";
    return;
  }

  msg.innerText="";
  ok.style.display="none";

  const monto = parseFloat(document.getElementById("monto").value);
  const plazo = parseInt(document.getElementById("plazo").value);
  const tasaAnual = parseFloat(document.getElementById("tasa").value)/100;
  const fecha = document.getElementById("fecha").value || new Date().toISOString().split("T")[0];

  const r = Math.pow(1+tasaAnual,1/12)-1;
  const cuota = monto * (r*Math.pow(1+r,plazo))/(Math.pow(1+r,plazo)-1);

  let saldo = monto;
  let totalInteres = 0;
  let totalAmort = 0;

  tabla.innerHTML = "";

  for(let i=1;i<=plazo;i++){
    let interes = saldo*r;
    let amort = cuota - interes;
    saldo -= amort;

    totalInteres += interes;
    totalAmort += amort;

    tabla.innerHTML += `
      <tr>
        <td>${i}</td>
        <td>S/ ${amort.toFixed(2)}</td>
        <td>S/ ${interes.toFixed(2)}</td>
        <td>S/ ${cuota.toFixed(2)}</td>
        <td>S/ ${saldo.toFixed(2)}</td>
      </tr>`;
  }

  resumen.style.display="block";
  resumen.innerHTML = `
    <h3>Resumen del Cr√©dito</h3>
    <p><b>Cuota Mensual:</b> S/ ${cuota.toFixed(2)}</p>
    <p><b>Total Amortizado:</b> S/ ${totalAmort.toFixed(2)}</p>
    <p><b>Total Intereses:</b> S/ ${totalInteres.toFixed(2)}</p>
    <p><b>Total Pagado:</b> S/ ${(totalAmort+totalInteres).toFixed(2)}</p>
  `;

  const res = await fetch(api+'/loans',{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({clientId,propertyId,amount:monto,term_months:plazo,annual_rate:tasaAnual,start_date:fecha})
  });

  const js = await res.json();
  if(!res.ok){ msg.innerText=js.message || "Error"; return; }

  ok.style.display="block";
  ok.innerText="‚úÖ Cr√©dito guardado correctamente. ID Cr√©dito: "+js.loan.id;
};
</script>
<!-- BOTONES DE VOZ -->
<div id="voiceControls" style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:9999;">
  <button id="playVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#1a73e8;color:white;font-size:16px;cursor:pointer;">üîä Explicaci√≥n</button>
  <button id="pauseVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#fbbc05;color:white;font-size:16px;cursor:pointer;">‚è∏ Pausa</button>
  <button id="resetVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#34a853;color:white;font-size:16px;cursor:pointer;">‚èÆ Reiniciar</button>
</div>

<script>
const speechText = `Bienvenido a la Generaci√≥n del Plan de Pagos. 
Esta secci√≥n calcula el cronograma de pagos de un cr√©dito hipotecario bajo el m√©todo franc√©s, generando cuotas fijas. 
Se consideran el monto del pr√©stamo, plazo en meses, tasa de inter√©s y la configuraci√≥n de moneda, tasa y periodo de gracia. 
El resultado incluye la cuota mensual, desglose de amortizaci√≥n, intereses y saldo restante. 
La tabla din√°mica permite visualizar todo de forma clara y responsiva.`;

const synth = window.speechSynthesis;
let utterance = null;
document.getElementById('playVoice').addEventListener('click', () => {
  if(synth.speaking) return;
  utterance = new SpeechSynthesisUtterance(speechText);
  utterance.lang = 'es-PE';
  synth.speak(utterance);
});
document.getElementById('pauseVoice').addEventListener('click', () => {
  if(synth.speaking && !synth.paused) synth.pause();
  else if(synth.paused) synth.resume();
});
document.getElementById('resetVoice').addEventListener('click', () => synth.cancel());
</script>
<!-- EFECTO RASTRO DE SIMBOLOS MATEMATICOS -->
<style>
  .math-trail {
    position: fixed;
    pointer-events: none;
    font-size: 18px;
    font-weight: bold;
    opacity: 1;
    transition: opacity 1.5s ease-out, transform 1.5s ease-out;
    z-index: 9999;
    color: #1a73e8;
  }
</style>

<script>
(function(){
  const symbols = ['$', '%', 'X', '+', '-', '=', '¬•', '‚Ç¨', '¬£', '¬¢', '‚àÜ', '‚àë', 'œÄ', '‚àö', '‚àû', '‚âà', '√∑', '√ó', '<', '>', '!', '@', '#', '&', '^', ':', ';', '?', '|', '~', '‚Ä¢'];
  
  function createTrail(x, y) {
    const span = document.createElement('span');
    span.classList.add('math-trail');
    span.style.left = x + 'px';
    span.style.top = y + 'px';
    span.style.fontSize = (12 + Math.random() * 16) + 'px';
    span.style.color = `hsl(${Math.random()*360}, 70%, 50%)`;
    span.innerText = symbols[Math.floor(Math.random() * symbols.length)];
    document.body.appendChild(span);

    // Animaci√≥n de desplazamiento y desaparici√≥n
    setTimeout(() => {
      span.style.transform = `translate(${Math.random()*30-15}px, ${Math.random()*30-15}px) rotate(${Math.random()*360}deg)`;
      span.style.opacity = 0;
    }, 50);

    setTimeout(() => document.body.removeChild(span), 1600);
  }

  // Movimiento de mouse
  window.addEventListener('mousemove', (e) => {
    createTrail(e.clientX, e.clientY);
  });

  // Movimiento t√°ctil (mobile)
  window.addEventListener('touchmove', (e) => {
    for(let i=0; i<e.touches.length; i++) {
      createTrail(e.touches[i].clientX, e.touches[i].clientY);
    }
  });
})();
</script>

</body>
</html>
