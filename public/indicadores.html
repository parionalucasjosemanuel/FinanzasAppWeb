<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="icon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indicadores Financieros - MiHogarFinanzas</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif;}
    body {display: flex; min-height: 100vh; background: #f4f6f9;}

    .sidebar {
      width: 250px; background: #1a73e8; color: white;
      display: flex; flex-direction: column; padding: 1rem;
      flex-shrink: 0;
    }
    .sidebar h3 {text-align: center; margin-bottom: 2rem;}
    .sidebar a {
      text-decoration: none; color: white; padding: 0.6rem 0.8rem;
      display: block; border-radius: 8px; transition: 0.3s;
    }
    .sidebar a:hover {background: #0f5dd1;}
    .main {flex: 1; padding: 2rem; overflow-y: auto; min-width: 0;}
    .logout {margin-top: auto; text-align: center;}
    .logout button {
      background: red; border: none; color: white; padding: 0.7rem 1rem;
      border-radius: 8px; cursor: pointer; transition: 0.3s; width: 100%;
    }
    .logout button:hover {background: darkred;}

    .brand {
      display: flex; align-items: center; justify-content: center;
      gap: 10px; margin-bottom: 2rem;
    }
    .brand img {width: 35px; height: 35px; border-radius: 50%; object-fit: cover;}
    .brand span {font-weight: bold; font-size: 1.1rem;}

    h1 {color: #1a73e8; margin-bottom: 1rem;}
    
    .content-box {
      background: white; padding: 1.5rem; border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem;
    }

    label {display: block; margin-top: 0.8rem; font-size: 0.9rem; color: #333;}
    select, input {
      width: 100%; padding: 0.7rem; border: 1px solid #ccc;
      border-radius: 8px; margin-top: 0.3rem;
    }
    button {
      margin-top: 1rem; padding: 0.8rem 1.5rem; border: none; border-radius: 8px;
      background: #1a73e8; color: white; font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    button:hover {background: #0f5dd1;}

    .indicadores-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem; margin-top: 1rem;
    }
    .indicador-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 1.5rem; border-radius: 12px;
      text-align: center;
    }
    .indicador-card.van {background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);}
    .indicador-card.tir {background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);}
    .indicador-card.tcea {background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);}
    .indicador-card h3 {font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;}
    .indicador-card .valor {font-size: 1.8rem; font-weight: bold;}
    .indicador-card small {display: block; margin-top: 0.5rem; opacity: 0.8;}

    .info-prestamo {
      background: #e8f0fe; padding: 1rem; border-radius: 8px;
      border-left: 4px solid #1a73e8; margin-bottom: 1rem;
    }
    .info-prestamo p {margin: 0.3rem 0;}

    .table-responsive {width: 100%; overflow-x: auto; margin-top: 1rem;}
    table {width: 100%; border-collapse: collapse; min-width: 600px;}
    th, td {padding: 0.8rem; text-align: center; border-bottom: 1px solid #ddd;}
    th {background: #1a73e8; color: white;}
    tr:hover {background: #f5f5f5;}

    /* Responsive */
    @media (max-width: 900px) {
      body {flex-direction: column;}
      .sidebar {
        width: 100%; flex-direction: row; flex-wrap: wrap;
        justify-content: center; padding: 0.5rem;
      }
      .sidebar a {padding: 0.5rem 0.8rem; margin: 0.2rem; font-size: 0.85rem;}
      .brand {width: 100%; margin-bottom: 0.5rem;}
      .logout {width: 100%; margin-top: 0.5rem;}
      .main {padding: 1rem;}
    }
    @media (max-width: 600px) {
      .sidebar a {flex: 1 1 45%; text-align: center; font-size: 0.8rem;}
      h1 {font-size: 1.3rem;}
      .indicador-card .valor {font-size: 1.4rem;}
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="brand">
      <img src="logo.png" alt="Logo">
      <span>MiHogarFinanzas</span>
    </div>
    <a href="/dashboard.html">üè† Dashboard</a>
    <a href="/clientes.html">üë§ Clientes</a>
    <a href="/inmuebles.html">üèòÔ∏è Unidades</a>
    <a href="/configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <a href="/planpagos.html">üìä Plan de Pagos</a>
    <a href="/indicadores.html">üìà Indicadores</a>
    <a href="/reportes.html">üóÇ Reportes</a>
    <a href="/ayuda.html">‚ùì Ayuda</a>
    <div class="logout">
      <button id="logout">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <div class="main">
    <h1>üìà Indicadores Financieros de Pr√©stamos</h1>

    <div class="content-box">
      <h2>Seleccionar Pr√©stamo</h2>
      <label>Pr√©stamo Registrado</label>
      <select id="loanSelect">
        <option value="">Cargando pr√©stamos...</option>
      </select>

      <label>Tasa de Descuento Anual (%) - COK</label>
      <input type="number" id="tasaDescuento" step="0.01" value="20" min="0" max="100">
      <small style="color:#666;">Carga autom√°ticamente la tasa del pr√©stamo, pero puedes modificarla para an√°lisis de sensibilidad</small>

      <button id="calcular">Calcular Indicadores</button>
    </div>

    <!-- Info del pr√©stamo seleccionado -->
    <div class="content-box" id="infoBox" style="display:none;">
      <h2>Informaci√≥n del Pr√©stamo</h2>
      <div class="info-prestamo" id="infoPrestamo"></div>

      <!-- Indicadores VAN, TIR, TCEA -->
      <div class="indicadores-grid" id="indicadoresGrid"></div>

      <!-- Cronograma resumido -->
      <h3 style="margin-top:1.5rem;">Cronograma de Pagos</h3>
      <div class="table-responsive">
        <table id="tablaCronograma">
          <thead>
            <tr>
              <th>Cuota</th>
              <th>Tipo</th>
              <th>Amortizaci√≥n</th>
              <th>Inter√©s</th>
              <th>Cuota Total</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const api = '/api';
    const token = localStorage.getItem('mhf_token');
    if (!token) { alert('Inicia sesi√≥n'); location.href = '/login.html'; }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('mhf_token');
      localStorage.removeItem('mhf_user');
      window.location.href = '/login.html';
    };

    let prestamosData = [];

    // Cargar pr√©stamos
    async function loadLoans() {
      try {
        const res = await fetch(api + '/loans', { headers: { Authorization: 'Bearer ' + token } });
        const loans = await res.json();
        prestamosData = loans;

        const select = document.getElementById('loanSelect');
        if (loans.length === 0) {
          select.innerHTML = '<option value="">No hay pr√©stamos registrados</option>';
        } else {
          select.innerHTML = '<option value="">Seleccione un pr√©stamo...</option>' +
            loans.map(l => `<option value="${l.id}">
              #${l.id} - ${l.Client ? l.Client.full_name : 'Cliente'} - 
              ${l.moneda === 'USD' ? '$' : 'S/'} ${parseFloat(l.amount).toLocaleString()} - 
              ${l.term_months} meses
            </option>`).join('');
        }
      } catch (err) {
        console.error('Error cargando pr√©stamos:', err);
        document.getElementById('loanSelect').innerHTML = '<option value="">Error al cargar</option>';
      }
    }

    loadLoans();

    // Cuando se selecciona un pr√©stamo, cargar su tasa de descuento
    document.getElementById('loanSelect').onchange = function() {
      const loanId = parseInt(this.value);
      if (!loanId) {
        document.getElementById('tasaDescuento').value = 20;
        return;
      }
      const loan = prestamosData.find(l => l.id === loanId);
      if (loan && loan.tasa_descuento) {
        // La tasa est√° guardada como decimal (0.20), convertir a porcentaje
        document.getElementById('tasaDescuento').value = (parseFloat(loan.tasa_descuento) * 100).toFixed(2);
      } else {
        document.getElementById('tasaDescuento').value = 20;
      }
    };

    // Funciones de c√°lculo
    function monthlyRateFromAnnual(annualRate) {
      return Math.pow(1 + annualRate, 30 / 360) - 1;
    }

    function nominalToEffective(nominalRate, capitalizacion) {
      const periodos = { 'mensual': 12, 'trimestral': 4, 'semestral': 2, 'anual': 1 };
      const n = periodos[capitalizacion] || 12;
      return Math.pow(1 + nominalRate / n, n) - 1;
    }

    function generarCronograma(amount, months, annualRate, tipoGracia, mesesGracia) {
      const r = monthlyRateFromAnnual(annualRate);
      let balance = amount;
      let schedule = [];

      // Meses de gracia
      for (let i = 1; i <= mesesGracia; i++) {
        const interest = balance * r;
        if (tipoGracia === 'total') {
          balance += interest;
          schedule.push({ num: i, amort: 0, interest: 0, total: 0, balance, tipo: 'Gracia Total' });
        } else if (tipoGracia === 'parcial') {
          schedule.push({ num: i, amort: 0, interest, total: interest, balance, tipo: 'Gracia Parcial' });
        }
      }

      const mesesRestantes = months - mesesGracia;
      if (mesesRestantes <= 0) return { cuota: 0, schedule, flujos: [] };

      const cuota = balance * (r * Math.pow(1 + r, mesesRestantes)) / (Math.pow(1 + r, mesesRestantes) - 1);

      for (let i = mesesGracia + 1; i <= months; i++) {
        const interest = balance * r;
        let amort = cuota - interest;
        
        // En la √∫ltima cuota, ajustar para que el saldo quede exactamente en 0
        if (i === months) {
          amort = balance;
        }
        
        balance = Math.max(0, balance - amort);
        const totalCuota = (i === months) ? amort + interest : cuota;
        
        schedule.push({ num: i, amort, interest, total: totalCuota, balance, tipo: 'Normal' });
      }

      const flujos = schedule.map(s => s.total);
      return { cuota, schedule, flujos };
    }

    function calcularVAN(monto, flujos, tasaDescuentoAnual) {
      const tasaMensual = Math.pow(1 + tasaDescuentoAnual, 1 / 12) - 1;
      let vna = 0;
      for (let i = 0; i < flujos.length; i++) {
        vna += flujos[i] / Math.pow(1 + tasaMensual, i + 1);
      }
      return { van: -monto + vna, tasaMensual };
    }

    function calcularTIR(monto, flujos) {
      function npv(rate) {
        let sum = -monto;
        for (let i = 0; i < flujos.length; i++) {
          sum += flujos[i] / Math.pow(1 + rate, i + 1);
        }
        return sum;
      }
      let low = 0, high = 1, mid;
      for (let i = 0; i < 100; i++) {
        mid = (low + high) / 2;
        if (npv(mid) > 0) low = mid;
        else high = mid;
      }
      return mid;
    }

    // Calcular indicadores
    document.getElementById('calcular').onclick = function () {
      const loanId = parseInt(document.getElementById('loanSelect').value);
      const tasaDescuento = parseFloat(document.getElementById('tasaDescuento').value) / 100;

      if (!loanId) {
        alert('‚ùå Seleccione un pr√©stamo');
        return;
      }
      if (isNaN(tasaDescuento) || tasaDescuento <= 0 || tasaDescuento > 1) {
        alert('‚ùå La tasa de descuento debe estar entre 0% y 100%');
        return;
      }

      const loan = prestamosData.find(l => l.id === loanId);
      if (!loan) {
        alert('‚ùå Pr√©stamo no encontrado');
        return;
      }

      // Extraer datos del pr√©stamo
      const montoOriginal = parseFloat(loan.amount);
      const bonoMonto = parseFloat(loan.bono_monto) || 0;
      const bonoAplica = loan.bono_techo;
      const montoReal = bonoAplica ? montoOriginal - bonoMonto : montoOriginal;

      const plazo = loan.term_months;
      // La tasa ya viene como decimal del backend (ej: 0.11 para 11%)
      let tasaEfectiva = parseFloat(loan.annual_rate);

      // Convertir si es nominal (ya no es necesario, el backend ya lo hizo)
      // if (loan.tipo_tasa === 'nominal') {
      //   tasaEfectiva = nominalToEffective(tasaEfectiva, loan.capitalizacion || 'mensual');
      // }

      const tipoGracia = loan.periodo_gracia || 'ninguno';
      const mesesGracia = loan.meses_gracia || 0;
      const moneda = loan.moneda || 'PEN';
      const simbolo = moneda === 'USD' ? '$' : 'S/';

      // Generar cronograma y flujos
      const { cuota, schedule, flujos } = generarCronograma(montoReal, plazo, tasaEfectiva, tipoGracia, mesesGracia);

      // Calcular indicadores
      const { van, tasaMensual } = calcularVAN(montoReal, flujos, tasaDescuento);
      const tirMensual = calcularTIR(montoReal, flujos);
      const tirAnual = Math.pow(1 + tirMensual, 12) - 1;

      // Totales
      let totalInteres = 0, totalAmort = 0, totalPagado = 0;
      schedule.forEach(s => {
        totalInteres += s.interest;
        totalAmort += s.amort;
        totalPagado += s.total;
      });

      // Mostrar info del pr√©stamo
      document.getElementById('infoBox').style.display = 'block';
      document.getElementById('infoPrestamo').innerHTML = `
        <p><b>Cliente:</b> ${loan.Client ? loan.Client.full_name : 'N/A'}</p>
        <p><b>Propiedad:</b> ${loan.Property ? loan.Property.project_name : 'N/A'}</p>
        <p><b>Monto Original:</b> ${simbolo} ${montoOriginal.toLocaleString()}</p>
        ${bonoAplica ? `<p><b>Bono Techo Propio:</b> - ${simbolo} ${bonoMonto.toLocaleString()}</p>` : ''}
        <p><b>Monto Financiado:</b> ${simbolo} ${montoReal.toLocaleString()}</p>
        <p><b>Plazo:</b> ${plazo} meses</p>
        <p><b>TEA:</b> ${(parseFloat(loan.annual_rate) * 100).toFixed(2)}%</p>
        <p><b>Tasa de Descuento (COK):</b> ${(tasaDescuento * 100).toFixed(2)}%</p>
        <p><b>Periodo de Gracia:</b> ${tipoGracia} (${mesesGracia} meses)</p>
        <p><b>Cuota Mensual:</b> ${simbolo} ${cuota.toFixed(2)}</p>
        <p><b>Total a Pagar:</b> ${simbolo} ${totalPagado.toFixed(2)}</p>
        <p><b>Total Intereses:</b> ${simbolo} ${totalInteres.toFixed(2)}</p>
      `;

      // Mostrar indicadores en cards
      document.getElementById('indicadoresGrid').innerHTML = `
        <div class="indicador-card van">
          <h3>VAN del Pr√©stamo</h3>
          <div class="valor">${simbolo} ${van.toFixed(2)}</div>
          <small>${van > 0 ? '‚úÖ Genera valor' : '‚ö†Ô∏è Por debajo del COK'}</small>
          <small>Tasa desc: ${(tasaMensual * 100).toFixed(4)}% mensual</small>
        </div>
        <div class="indicador-card tir">
          <h3>TIR Mensual</h3>
          <div class="valor">${(tirMensual * 100).toFixed(4)}%</div>
          <small>Rentabilidad mensual del cr√©dito</small>
        </div>
        <div class="indicador-card tcea">
          <h3>TCEA (TIR Anual)</h3>
          <div class="valor">${(tirAnual * 100).toFixed(2)}%</div>
          <small>Costo Efectivo Anual real</small>
        </div>
      `;

      // Mostrar cronograma
      const tbody = document.querySelector('#tablaCronograma tbody');
      tbody.innerHTML = schedule.map(s => `
        <tr style="${s.tipo !== 'Normal' ? 'background:#fff3cd;' : ''}">
          <td>${s.num}</td>
          <td>${s.tipo}</td>
          <td>${simbolo} ${s.amort.toFixed(2)}</td>
          <td>${simbolo} ${s.interest.toFixed(2)}</td>
          <td>${simbolo} ${s.total.toFixed(2)}</td>
          <td>${simbolo} ${s.balance.toFixed(2)}</td>
        </tr>
      `).join('');
    };
  </script>

  <!-- BOTONES DE VOZ -->
  <div id="voiceControls" style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:9999;">
    <button id="playVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#1a73e8;color:white;font-size:16px;cursor:pointer;">üîä Explicaci√≥n</button>
    <button id="pauseVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#fbbc05;color:white;font-size:16px;cursor:pointer;">‚è∏ Pausa</button>
    <button id="resetVoice" style="padding:10px 15px;border:none;border-radius:50px;background:#34a853;color:white;font-size:16px;cursor:pointer;">‚èÆ Reiniciar</button>
  </div>

  <script>
    const speechText = `Bienvenido a los Indicadores Financieros. 
    Esta secci√≥n permite consultar los indicadores VAN, TIR y TCEA de los pr√©stamos registrados en el sistema.
    Seleccione un pr√©stamo del listado y especifique la tasa de descuento o costo de oportunidad del capital.
    El sistema calcular√° autom√°ticamente los indicadores bas√°ndose en los flujos reales del cronograma de pagos.
    El VAN indica si la operaci√≥n genera valor por encima del costo de oportunidad.
    La TIR representa la rentabilidad real del cr√©dito.
    La TCEA es el Costo Efectivo Anual que el cliente paga realmente.`;

    const synth = window.speechSynthesis;
    let utterance = null;
    document.getElementById('playVoice').addEventListener('click', () => {
      if (synth.speaking) return;
      utterance = new SpeechSynthesisUtterance(speechText);
      utterance.lang = 'es-PE';
      synth.speak(utterance);
    });
    document.getElementById('pauseVoice').addEventListener('click', () => {
      if (synth.speaking && !synth.paused) synth.pause();
      else if (synth.paused) synth.resume();
    });
    document.getElementById('resetVoice').addEventListener('click', () => synth.cancel());
  </script>

  <!-- EFECTO RASTRO DE SIMBOLOS MATEMATICOS -->
  <style>
    .math-trail {
      position: fixed; pointer-events: none; font-size: 18px;
      font-weight: bold; opacity: 1;
      transition: opacity 1.5s ease-out, transform 1.5s ease-out;
      z-index: 9999; color: #1a73e8;
    }
  </style>
  <script>
    (function () {
      const symbols = ['$', '%', 'X', '+', '-', '=', '¬•', '‚Ç¨', '¬£', '¬¢', '‚àÜ', '‚àë', 'œÄ', '‚àö', '‚àû', '‚âà', '√∑', '√ó'];
      function createTrail(x, y) {
        const span = document.createElement('span');
        span.classList.add('math-trail');
        span.style.left = x + 'px';
        span.style.top = y + 'px';
        span.style.fontSize = (12 + Math.random() * 16) + 'px';
        span.style.color = `hsl(${Math.random() * 360}, 70%, 50%)`;
        span.innerText = symbols[Math.floor(Math.random() * symbols.length)];
        document.body.appendChild(span);
        setTimeout(() => {
          span.style.transform = `translate(${Math.random() * 30 - 15}px, ${Math.random() * 30 - 15}px) rotate(${Math.random() * 360}deg)`;
          span.style.opacity = 0;
        }, 50);
        setTimeout(() => document.body.removeChild(span), 1600);
      }
      window.addEventListener('mousemove', (e) => createTrail(e.clientX, e.clientY));
      window.addEventListener('touchmove', (e) => {
        for (let i = 0; i < e.touches.length; i++) {
          createTrail(e.touches[i].clientX, e.touches[i].clientY);
        }
      });
    })();
  </script>
</body>
</html>
